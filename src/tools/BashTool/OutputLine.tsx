/**
 * ğŸ¯ è¾“å‡ºè¡Œç»„ä»¶ - å‘½ä»¤è¾“å‡ºå†…å®¹çš„æ™ºèƒ½æ¸²æŸ“å’Œæ˜¾ç¤ºæ¨¡å—
 *
 * ğŸ—ï¸ æ ¸å¿ƒåŠŸèƒ½ï¼š
 * - æä¾›å‘½ä»¤è¾“å‡ºå†…å®¹çš„çµæ´»æ˜¾ç¤ºå’Œæˆªæ–­å¤„ç†
 * - æ”¯æŒè¯¦ç»†æ¨¡å¼å’Œç®€æ´æ¨¡å¼çš„åŠ¨æ€åˆ‡æ¢
 * - é›†æˆé”™è¯¯çŠ¶æ€çš„å·®å¼‚åŒ–è§†è§‰æ ·å¼
 * - å®ç°é•¿è¾“å‡ºçš„æ™ºèƒ½æˆªæ–­å’Œé¢„è§ˆ
 * - æä¾›ä¸€è‡´çš„å¸ƒå±€å’Œç”¨æˆ·ä½“éªŒ
 *
 * ğŸ”„ ä¾èµ–å…³ç³»ï¼š
 * - ä¸Šæ¸¸ï¼šè¢« BashToolResultMessage ä½¿ç”¨è¿›è¡Œå†…å®¹æ¸²æŸ“
 * - ä¸‹æ¸¸ï¼šä¾èµ– Ink UIã€ä¸»é¢˜ç³»ç»Ÿã€Chalk é¢œè‰²å¤„ç†
 *
 * ğŸ“Š ä½¿ç”¨åœºæ™¯ï¼š
 * - æ ‡å‡†è¾“å‡ºå’Œé”™è¯¯è¾“å‡ºçš„ç»Ÿä¸€æ¸²æŸ“
 * - é•¿å‘½ä»¤è¾“å‡ºçš„æˆªæ–­å’Œé¢„è§ˆæ˜¾ç¤º
 * - ç»ˆç«¯ç•Œé¢çš„ä¸€è‡´æ€§å¸ƒå±€æ§åˆ¶
 * - ä¸åŒè¾“å‡ºç±»å‹çš„è§†è§‰åŒºåˆ†
 *
 * ğŸ”§ æŠ€æœ¯å®ç°ï¼š
 * - æ™ºèƒ½æˆªæ–­ï¼šä¿ç•™è¾“å‡ºæœ«å°¾çš„å…³é”®ä¿¡æ¯
 * - ä¸»é¢˜é›†æˆï¼šé”™è¯¯è¾“å‡ºçš„é¢œè‰²å·®å¼‚åŒ–
 * - å“åº”å¼å¸ƒå±€ï¼šé€‚åº”ä¸åŒç»ˆç«¯å®½åº¦
 * - æ€§èƒ½ä¼˜åŒ–ï¼šé¿å…æ¸²æŸ“è¿‡é•¿å†…å®¹å½±å“æ€§èƒ½
 *
 * ğŸ’¡ è®¾è®¡åŸåˆ™ï¼š
 * - ä¿¡æ¯ä¼˜å…ˆï¼šç¡®ä¿é‡è¦ä¿¡æ¯çš„å¯è§æ€§
 * - è§†è§‰æ¸…æ™°ï¼šåŒºåˆ†ä¸åŒç±»å‹è¾“å‡ºçš„æ ·å¼
 * - æ€§èƒ½å‹å¥½ï¼šåˆç†æ§åˆ¶æ¸²æŸ“å†…å®¹çš„é•¿åº¦
 * - ä¸€è‡´ä½“éªŒï¼šç»Ÿä¸€çš„ç•Œé¢å¸ƒå±€å’Œäº¤äº’
 */
import { Box, Text } from 'ink'
import * as React from 'react'
import { getTheme } from '../../utils/theme'
import { MAX_RENDERED_LINES } from './prompt'
import chalk from 'chalk'

/**
 * ğŸ“ æˆªæ–­å†…å®¹æ¸²æŸ“å‡½æ•° - æ™ºèƒ½å¤„ç†é•¿è¾“å‡ºå†…å®¹çš„æ˜¾ç¤ºç­–ç•¥
 *
 * å¯¹è¶…è¿‡æ˜¾ç¤ºè¡Œæ•°é™åˆ¶çš„å†…å®¹è¿›è¡Œæ™ºèƒ½æˆªæ–­ï¼Œä¿ç•™æœ€åçš„å…³é”®è¡Œæ•°
 * å¹¶æä¾›æˆªæ–­ä¿¡æ¯çš„å‹å¥½æç¤ºã€‚
 *
 * @param content - éœ€è¦å¤„ç†çš„åŸå§‹å†…å®¹å­—ç¬¦ä¸²
 * @param totalLines - åŸå§‹å†…å®¹çš„æ€»è¡Œæ•°
 * @returns å¤„ç†åçš„æ˜¾ç¤ºå†…å®¹å­—ç¬¦ä¸²
 *
 * ğŸ”„ å¤„ç†ç­–ç•¥ï¼š
 * â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
 * â”‚                  å†…å®¹æˆªæ–­å¤„ç†ç­–ç•¥                            â”‚
 * â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
 * â”‚ çŸ­å†…å®¹æƒ…å†µ       â”‚ è¡Œæ•° â‰¤ MAX_RENDERED_LINES                â”‚
 * â”‚                 â”‚ â€¢ ç›´æ¥è¿”å›å®Œæ•´å†…å®¹                        â”‚
 * â”‚                 â”‚ â€¢ æ— éœ€æˆªæ–­å’Œæç¤ºä¿¡æ¯                      â”‚
 * â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
 * â”‚ é•¿å†…å®¹æˆªæ–­       â”‚ è¡Œæ•° > MAX_RENDERED_LINES                â”‚
 * â”‚                 â”‚ â€¢ ä¿ç•™æœ€åNè¡Œå†…å®¹                         â”‚
 * â”‚                 â”‚ â€¢ æ·»åŠ æˆªæ–­ä¿¡æ¯æç¤º                        â”‚
 * â”‚                 â”‚ â€¢ æ˜¾ç¤ºæ€»è¡Œæ•°ç»Ÿè®¡                          â”‚
 * â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
 *
 * ğŸ’¡ è®¾è®¡è€ƒè™‘ï¼š
 * â€¢ æœ«å°¾ä¿ç•™ç­–ç•¥ï¼šé€šå¸¸æœ€åçš„è¾“å‡ºåŒ…å«æœ€é‡è¦çš„ç»“æœä¿¡æ¯
 * â€¢ ç°è‰²æç¤ºæ–‡æœ¬ï¼šä½¿ç”¨chalk.grey()æä¾›éä¾µå…¥æ€§çš„ä¿¡æ¯æç¤º
 * â€¢ è¡Œæ•°ç»Ÿè®¡ï¼šå¸®åŠ©ç”¨æˆ·äº†è§£å®Œæ•´è¾“å‡ºçš„è§„æ¨¡
 * â€¢ æ€§èƒ½ä¼˜åŒ–ï¼šé¿å…æ¸²æŸ“è¿‡å¤šå†…å®¹å¯¼è‡´ç•Œé¢å¡é¡¿
 */
function renderTruncatedContent(content: string, totalLines: number): string {
  const allLines = content.split('\n')
  if (allLines.length <= MAX_RENDERED_LINES) {
    return allLines.join('\n')
  }

  // Show last 5 lines of output by default (matching reference implementation)
  const lastLines = allLines.slice(-MAX_RENDERED_LINES)
  return [
    chalk.grey(
      `Showing last ${MAX_RENDERED_LINES} lines of ${totalLines} total lines`,
    ),
    ...lastLines,
  ].join('\n')
}

/**
 * ğŸ“ è¾“å‡ºè¡Œç»„ä»¶ - ç»Ÿä¸€çš„å‘½ä»¤è¾“å‡ºæ¸²æŸ“å™¨
 *
 * æä¾›æ ‡å‡†åŒ–çš„å‘½ä»¤è¾“å‡ºæ˜¾ç¤ºç»„ä»¶ï¼Œæ”¯æŒå¤šç§æ˜¾ç¤ºæ¨¡å¼å’Œè§†è§‰çŠ¶æ€ã€‚
 * æ˜¯Bashå·¥å…·è¾“å‡ºå±•ç¤ºçš„åŸºç¡€æ„å»ºå•å…ƒã€‚
 *
 * @param props - ç»„ä»¶å±æ€§å¯¹è±¡
 * @param {string} props.content - è¦æ˜¾ç¤ºçš„è¾“å‡ºå†…å®¹
 * @param {number} props.lines - åŸå§‹è¾“å‡ºçš„æ€»è¡Œæ•°
 * @param {boolean} props.verbose - æ˜¯å¦å¯ç”¨è¯¦ç»†æ¨¡å¼æ˜¾ç¤º
 * @param {boolean} [props.isError] - æ˜¯å¦ä¸ºé”™è¯¯è¾“å‡ºï¼ˆå½±å“é¢œè‰²æ ·å¼ï¼‰
 * @param {React.Key} [props.key] - React keyå±æ€§ï¼ˆç”¨äºåˆ—è¡¨æ¸²æŸ“ï¼‰
 * @returns {JSX.Element} æ¸²æŸ“åçš„è¾“å‡ºè¡Œç»„ä»¶
 *
 * ğŸ¨ æ¸²æŸ“æ¨¡å¼è¯¦è§£ï¼š
 * â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
 * â”‚                  è¾“å‡ºæ˜¾ç¤ºæ¨¡å¼æ§åˆ¶                            â”‚
 * â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
 * â”‚ è¯¦ç»†æ¨¡å¼         â”‚ verbose = true                           â”‚
 * â”‚ (verbose=true)   â”‚ â€¢ æ˜¾ç¤ºå®Œæ•´çš„åŸå§‹å†…å®¹                     â”‚
 * â”‚                 â”‚ â€¢ ä¸è¿›è¡Œä»»ä½•æˆªæ–­å¤„ç†                      â”‚
 * â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
 * â”‚ ç®€æ´æ¨¡å¼         â”‚ verbose = false                          â”‚
 * â”‚ (verbose=false)  â”‚ â€¢ ä½¿ç”¨renderTruncatedContentæˆªæ–­æ˜¾ç¤º     â”‚
 * â”‚                 â”‚ â€¢ æ™ºèƒ½ä¿ç•™æœ«å°¾å…³é”®ä¿¡æ¯                    â”‚
 * â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
 * â”‚ é”™è¯¯æ ·å¼         â”‚ isError = true                           â”‚
 * â”‚ (isError=true)   â”‚ â€¢ åº”ç”¨ä¸»é¢˜çš„é”™è¯¯é¢œè‰²                     â”‚
 * â”‚                 â”‚ â€¢ è§†è§‰ä¸ŠåŒºåˆ†é”™è¯¯è¾“å‡º                      â”‚
 * â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
 *
 * ğŸ¯ å¸ƒå±€ç»“æ„ï¼š
 * ```
 * â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
 * â”‚  â¿ â”‚ è¾“å‡ºå†…å®¹ï¼ˆæ ¹æ®verboseæ¨¡å¼å†³å®šæ˜¯å¦æˆªæ–­ï¼‰                â”‚
 * â”‚    â”‚ â€¢ æ ‡å‡†è¾“å‡ºï¼šé»˜è®¤é¢œè‰²                                   â”‚
 * â”‚    â”‚ â€¢ é”™è¯¯è¾“å‡ºï¼šé”™è¯¯ä¸»é¢˜é¢œè‰²                               â”‚
 * â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
 * ```
 *
 * ğŸ’¡ è®¾è®¡ç‰¹ç‚¹ï¼š
 * â€¢ ç»Ÿä¸€æ ‡è¯†ç¬¦ï¼šä½¿ç”¨ "â¿" ç¬¦å·ä½œä¸ºè¾“å‡ºè¡Œçš„è§†è§‰æ ‡è¯†
 * â€¢ å“åº”å¼å®½åº¦ï¼šç»„ä»¶å®½åº¦è‡ªåŠ¨é€‚åº”å®¹å™¨
 * â€¢ ä¸»é¢˜é›†æˆï¼šé¢œè‰²æ ·å¼éµå¾ªå…¨å±€ä¸»é¢˜è®¾ç½®
 * â€¢ çµæ´»å¸ƒå±€ï¼šæ”¯æŒå„ç§å†…å®¹é•¿åº¦çš„è‡ªé€‚åº”æ˜¾ç¤º
 */
export function OutputLine({
  content,
  lines,
  verbose,
  isError,
}: {
  content: string   // è¾“å‡ºå†…å®¹å­—ç¬¦ä¸²
  lines: number     // åŸå§‹è¾“å‡ºæ€»è¡Œæ•°
  verbose: boolean  // è¯¦ç»†æ˜¾ç¤ºæ¨¡å¼
  isError?: boolean // é”™è¯¯è¾“å‡ºæ ‡å¿—ï¼ˆå¯é€‰ï¼‰
  key?: React.Key   // React key å±æ€§ï¼ˆå¯é€‰ï¼‰
}) {
  return (
    <Box justifyContent="space-between" width="100%">
      <Box flexDirection="row">
        <Text>&nbsp;&nbsp;â¿ &nbsp;</Text>
        <Box flexDirection="column">
          <Text color={isError ? getTheme().error : undefined}>
            {verbose
              ? content.trim()
              : renderTruncatedContent(content.trim(), lines)}
          </Text>
        </Box>
      </Box>
    </Box>
  )
}
