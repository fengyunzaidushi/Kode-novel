/**
 * ğŸ¯ FileEditTool å·¥å…·å‡½æ•°é›† - æ–‡ä»¶ç¼–è¾‘çš„æ ¸å¿ƒå®ç”¨å·¥å…·
 *
 * ğŸ—ï¸ æ ¸å¿ƒåŠŸèƒ½ï¼š
 * - æä¾›æ–‡ä»¶ç¼–è¾‘æ“ä½œçš„åº•å±‚å®ç°é€»è¾‘
 * - å®ç°ç²¾ç¡®çš„å­—ç¬¦ä¸²æ›¿æ¢å’Œå·®å¼‚è®¡ç®—
 * - æ”¯æŒæ–°æ–‡ä»¶åˆ›å»ºå’Œç°æœ‰æ–‡ä»¶ä¿®æ”¹
 * - é›†æˆæ™ºèƒ½çš„æ¢è¡Œç¬¦å¤„ç†æœºåˆ¶
 * - ç”Ÿæˆè¯¦ç»†çš„ç¼–è¾‘æ“ä½œå·®å¼‚æŠ¥å‘Š
 *
 * ğŸ”„ ä¾èµ–å…³ç³»ï¼š
 * - ä¸Šæ¸¸ï¼šè¢« FileEditTool ä¸»å·¥å…·è°ƒç”¨
 * - ä¸‹æ¸¸ï¼šä¾èµ–æ–‡ä»¶ç³»ç»Ÿã€ç¼–ç æ£€æµ‹ã€å·®å¼‚è®¡ç®—
 *
 * ğŸ“Š ä½¿ç”¨åœºæ™¯ï¼š
 * - ä»£ç æ–‡ä»¶çš„ç²¾ç¡®è¡Œçº§ç¼–è¾‘
 * - é…ç½®æ–‡ä»¶çš„é”®å€¼å¯¹ä¿®æ”¹
 * - æ–‡æ¡£å†…å®¹çš„å±€éƒ¨æ›´æ–°
 * - æ‰¹é‡æ–‡æœ¬æ›¿æ¢æ“ä½œ
 *
 * ğŸ”§ æŠ€æœ¯å®ç°ï¼š
 * - è·¯å¾„è§£æï¼šæ”¯æŒç›¸å¯¹è·¯å¾„å’Œç»å¯¹è·¯å¾„
 * - ç¼–ç ä¿æŒï¼šè‡ªåŠ¨æ£€æµ‹å’Œä¿æŒåŸæ–‡ä»¶ç¼–ç 
 * - æ™ºèƒ½æ›¿æ¢ï¼šå¤„ç†è¾¹ç•Œæƒ…å†µå’Œæ¢è¡Œç¬¦
 * - å·®å¼‚ç”Ÿæˆï¼šåˆ›å»ºå¯è§†åŒ–çš„ä¿®æ”¹å¯¹æ¯”
 *
 * ğŸ’¡ è®¾è®¡åŸåˆ™ï¼š
 * - éç ´åæ€§ï¼šä¸ç›´æ¥ä¿®æ”¹ç£ç›˜æ–‡ä»¶
 * - ç²¾ç¡®æ€§ï¼šç¡®ä¿æ›¿æ¢æ“ä½œçš„å‡†ç¡®æ€§
 * - å¯é¢„è§ˆï¼šç”Ÿæˆå®Œæ•´çš„ä¿®æ”¹å·®å¼‚
 * - å®¹é”™æ€§ï¼šä¼˜é›…å¤„ç†å„ç§è¾¹ç•Œæƒ…å†µ
 */
import { isAbsolute, resolve } from 'path'
import { getCwd } from '../../utils/state'
import { readFileSync } from 'fs'
import { detectFileEncoding } from '../../utils/file'
import { type Hunk } from 'diff'
import { getPatch } from '../../utils/diff'

/**
 * åº”ç”¨æ–‡ä»¶ç¼–è¾‘æ“ä½œå¹¶è¿”å›å·®å¼‚å’Œæ›´æ–°åçš„æ–‡ä»¶å†…å®¹
 *
 * è¿™æ˜¯æ–‡ä»¶ç¼–è¾‘ç³»ç»Ÿçš„æ ¸å¿ƒå‡½æ•°ï¼Œè´Ÿè´£å®‰å…¨åœ°æ‰§è¡Œæ–‡æœ¬æ›¿æ¢æ“ä½œï¼Œ
 * ç”Ÿæˆè¯¦ç»†çš„ä¿®æ”¹å·®å¼‚ï¼Œä½†ä¸ç›´æ¥å†™å…¥ç£ç›˜æ–‡ä»¶ã€‚
 *
 * @param file_path - ç›®æ ‡æ–‡ä»¶è·¯å¾„ï¼ˆæ”¯æŒç›¸å¯¹è·¯å¾„å’Œç»å¯¹è·¯å¾„ï¼‰
 * @param old_string - è¦è¢«æ›¿æ¢çš„åŸå§‹æ–‡æœ¬å†…å®¹
 * @param new_string - æ›¿æ¢åçš„æ–°æ–‡æœ¬å†…å®¹
 * @returns åŒ…å«å·®å¼‚ä¿¡æ¯å’Œæ›´æ–°æ–‡ä»¶å†…å®¹çš„å¯¹è±¡
 *
 * ğŸ”„ ç¼–è¾‘æµç¨‹è¯¦è§£ï¼š
 * â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
 * â”‚                    æ–‡ä»¶ç¼–è¾‘å¤„ç†æµç¨‹                          â”‚
 * â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
 * â”‚ 1. è·¯å¾„è§„èŒƒåŒ–  â”‚ â€¢ è½¬æ¢ä¸ºç»å¯¹è·¯å¾„                          â”‚
 * â”‚               â”‚ â€¢ ç¡®ä¿è·¯å¾„çš„ä¸€è‡´æ€§å’Œå®‰å…¨æ€§                â”‚
 * â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
 * â”‚ 2. æ“ä½œç±»å‹è¯†åˆ«â”‚ â€¢ æ–°æ–‡ä»¶åˆ›å»º (old_string == '')           â”‚
 * â”‚               â”‚ â€¢ ç°æœ‰æ–‡ä»¶ç¼–è¾‘ (old_string != '')         â”‚
 * â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
 * â”‚ 3. æ–‡ä»¶å†…å®¹å¤„ç†â”‚ â€¢ è‡ªåŠ¨ç¼–ç æ£€æµ‹                            â”‚
 * â”‚               â”‚ â€¢ æ™ºèƒ½æ¢è¡Œç¬¦å¤„ç†                           â”‚
 * â”‚               â”‚ â€¢ ç²¾ç¡®æ–‡æœ¬æ›¿æ¢                             â”‚
 * â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
 * â”‚ 4. ç»“æœéªŒè¯    â”‚ â€¢ æ£€æŸ¥æ›¿æ¢æ“ä½œæ˜¯å¦ç”Ÿæ•ˆ                    â”‚
 * â”‚               â”‚ â€¢ é˜²æ­¢æ— æ•ˆç¼–è¾‘æ“ä½œ                         â”‚
 * â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
 * â”‚ 5. å·®å¼‚ç”Ÿæˆ    â”‚ â€¢ åˆ›å»ºå¯è§†åŒ–å·®å¼‚å¯¹æ¯”                      â”‚
 * â”‚               â”‚ â€¢ ç”Ÿæˆç»“æ„åŒ–è¡¥ä¸ä¿¡æ¯                       â”‚
 * â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
 *
 * ğŸ’¡ ç‰¹æ®Šå¤„ç†é€»è¾‘ï¼š
 * - æ–°æ–‡ä»¶åˆ›å»ºï¼šold_string ä¸ºç©ºæ—¶ï¼Œç›´æ¥ä½¿ç”¨ new_string ä½œä¸ºæ–‡ä»¶å†…å®¹
 * - åˆ é™¤æ“ä½œï¼šnew_string ä¸ºç©ºæ—¶ï¼Œæ™ºèƒ½å¤„ç†æ¢è¡Œç¬¦ä»¥é¿å…ç©ºè¡Œé—®é¢˜
 * - æ¢è¡Œç¬¦ä¼˜åŒ–ï¼šè‡ªåŠ¨æ£€æµ‹å¹¶å¤„ç†è¡Œå°¾æ¢è¡Œç¬¦çš„è¾¹ç•Œæƒ…å†µ
 * - å¤±è´¥æ£€æµ‹ï¼šéªŒè¯æ›¿æ¢æ˜¯å¦æˆåŠŸï¼Œé˜²æ­¢é™é»˜å¤±è´¥
 *
 * ğŸš« å®‰å…¨ç‰¹æ€§ï¼š
 * - éç ´åæ€§ï¼šä¸ç›´æ¥ä¿®æ”¹ç£ç›˜æ–‡ä»¶
 * - åŸå­æ€§ï¼šè¦ä¹ˆå®Œå…¨æˆåŠŸï¼Œè¦ä¹ˆå®Œå…¨å¤±è´¥
 * - å¯é¢„è§ˆï¼šè¿”å›å®Œæ•´å·®å¼‚ä¾›ç”¨æˆ·ç¡®è®¤
 * - é”™è¯¯å¤„ç†ï¼šæ˜ç¡®çš„å¤±è´¥åŸå› åé¦ˆ
 */
export function applyEdit(
  file_path: string,
  old_string: string,
  new_string: string,
): { patch: Hunk[]; updatedFile: string } {
  /**
   * ğŸ›£ï¸ æ­¥éª¤ 1ï¼šè·¯å¾„è§„èŒƒåŒ–å¤„ç†
   * å°†è¾“å…¥çš„æ–‡ä»¶è·¯å¾„è½¬æ¢ä¸ºç»å¯¹è·¯å¾„ï¼Œç¡®ä¿è·¯å¾„è§£æçš„ä¸€è‡´æ€§ã€‚
   * æ”¯æŒç›¸å¯¹è·¯å¾„ï¼ˆåŸºäºå½“å‰å·¥ä½œç›®å½•ï¼‰å’Œç»å¯¹è·¯å¾„ã€‚
   */
  const fullFilePath = isAbsolute(file_path)
    ? file_path
    : resolve(getCwd(), file_path)

  /**
   * ğŸ“ æ­¥éª¤ 2ï¼šæ–‡ä»¶å†…å®¹å˜é‡åˆå§‹åŒ–
   * å‡†å¤‡å­˜å‚¨åŸå§‹æ–‡ä»¶å†…å®¹å’Œç¼–è¾‘åçš„æ–‡ä»¶å†…å®¹
   */
  let originalFile
  let updatedFile

  /**
   * ğŸ†• æ­¥éª¤ 3ï¼šç¼–è¾‘æ“ä½œç±»å‹åˆ¤æ–­å’Œå¤„ç†
   * æ ¹æ® old_string æ˜¯å¦ä¸ºç©ºæ¥åŒºåˆ†æ–°æ–‡ä»¶åˆ›å»ºå’Œç°æœ‰æ–‡ä»¶ç¼–è¾‘
   */
  if (old_string === '') {
    /**
     * ğŸ“„ æ–°æ–‡ä»¶åˆ›å»ºæ¨¡å¼
     * å½“ old_string ä¸ºç©ºæ—¶ï¼Œè¡¨ç¤ºè¿™æ˜¯ä¸€ä¸ªæ–°æ–‡ä»¶åˆ›å»ºæ“ä½œ
     * ç›´æ¥ä½¿ç”¨ new_string ä½œä¸ºå®Œæ•´çš„æ–‡ä»¶å†…å®¹
     */
    originalFile = ''
    updatedFile = new_string
  } else {
    /**
     * âœï¸ ç°æœ‰æ–‡ä»¶ç¼–è¾‘æ¨¡å¼
     * å¤„ç†å¯¹å·²å­˜åœ¨æ–‡ä»¶çš„ç¼–è¾‘æ“ä½œ
     */

    /**
     * ğŸ” è‡ªåŠ¨ç¼–ç æ£€æµ‹
     * æ£€æµ‹ç›®æ ‡æ–‡ä»¶çš„å­—ç¬¦ç¼–ç ï¼Œç¡®ä¿æ­£ç¡®è¯»å–æ–‡ä»¶å†…å®¹
     * è¿™å¯¹äºå¤„ç†ä¸åŒç¼–ç çš„æ–‡ä»¶ï¼ˆUTF-8, GBK, Latin-1ç­‰ï¼‰è‡³å…³é‡è¦
     */
    const enc = detectFileEncoding(fullFilePath)
    originalFile = readFileSync(fullFilePath, enc)

    /**
     * ğŸ—‘ï¸ æ™ºèƒ½åˆ é™¤æ“ä½œå¤„ç†
     * å½“ new_string ä¸ºç©ºæ—¶ï¼Œè¡¨ç¤ºåˆ é™¤æ“ä½œ
     * éœ€è¦ç‰¹åˆ«å¤„ç†æ¢è¡Œç¬¦ï¼Œé¿å…äº§ç”Ÿä¸å¿…è¦çš„ç©ºè¡Œ
     */
    if (new_string === '') {
      if (
        !old_string.endsWith('\n') &&
        originalFile.includes(old_string + '\n')
      ) {
        /**
         * ğŸ”§ æ™ºèƒ½æ¢è¡Œç¬¦å¤„ç†
         * å¦‚æœè¦åˆ é™¤çš„æ–‡æœ¬åé¢æœ‰æ¢è¡Œç¬¦ï¼Œä¸”åŸæ–‡æœ¬ä¸ä»¥æ¢è¡Œç¬¦ç»“å°¾ï¼Œ
         * åˆ™è¿åŒæ¢è¡Œç¬¦ä¸€èµ·åˆ é™¤ï¼Œé¿å…ç•™ä¸‹ç©ºè¡Œ
         */
        updatedFile = originalFile.replace(old_string + '\n', () => new_string)
      } else {
        /**
         * ğŸ“ æ ‡å‡†åˆ é™¤æ“ä½œ
         * ç›´æ¥åˆ é™¤æŒ‡å®šæ–‡æœ¬ï¼Œä¿æŒåŸæœ‰çš„æ¢è¡Œç¬¦ç»“æ„
         */
        updatedFile = originalFile.replace(old_string, () => new_string)
      }
    } else {
      /**
       * ğŸ”„ æ ‡å‡†æ›¿æ¢æ“ä½œ
       * å°†æŒ‡å®šçš„ old_string æ›¿æ¢ä¸º new_string
       * ä½¿ç”¨å‡½æ•°å½¢å¼çš„ replace ç¡®ä¿ç‰¹æ®Šå­—ç¬¦çš„æ­£ç¡®å¤„ç†
       */
      updatedFile = originalFile.replace(old_string, () => new_string)
    }

    /**
     * âœ… ç¼–è¾‘ç»“æœéªŒè¯
     * æ£€æŸ¥æ›¿æ¢æ“ä½œæ˜¯å¦å®é™…ç”Ÿæ•ˆï¼Œé˜²æ­¢é™é»˜å¤±è´¥
     * å¦‚æœæ–‡ä»¶å†…å®¹å®Œå…¨ç›¸åŒï¼Œè¯´æ˜æ›¿æ¢æ“ä½œæ²¡æœ‰æ‰¾åˆ°ç›®æ ‡å­—ç¬¦ä¸²
     */
    if (updatedFile === originalFile) {
      throw new Error(
        'Original and edited file match exactly. Failed to apply edit.',
      )
    }
  }

  /**
   * ğŸ“Š æ­¥éª¤ 4ï¼šå·®å¼‚è®¡ç®—å’Œè¡¥ä¸ç”Ÿæˆ
   * ç”Ÿæˆè¯¦ç»†çš„æ–‡ä»¶ä¿®æ”¹å·®å¼‚ä¿¡æ¯ï¼Œç”¨äºï¼š
   * - ç”¨æˆ·é¢„è§ˆä¿®æ”¹å†…å®¹
   * - ç•Œé¢æ˜¾ç¤ºä¿®æ”¹æ‘˜è¦
   * - ç‰ˆæœ¬æ§åˆ¶é›†æˆ
   * - æ’¤é”€æ“ä½œæ”¯æŒ
   */
  const patch = getPatch({
    filePath: file_path,
    fileContents: originalFile,
    oldStr: originalFile,
    newStr: updatedFile,
  })

  /**
   * ğŸ“¦ è¿”å›ç¼–è¾‘ç»“æœ
   * è¿”å›åŒ…å«å·®å¼‚ä¿¡æ¯å’Œæ›´æ–°åæ–‡ä»¶å†…å®¹çš„å®Œæ•´ç»“æœå¯¹è±¡
   */
  return { patch, updatedFile }
}
