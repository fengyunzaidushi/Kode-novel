/**
 * ğŸ¯ å¯¹è¯ä¸æ¶ˆæ¯ç³»ç»Ÿç±»å‹å®šä¹‰ - ç»Ÿä¸€çš„æ¶ˆæ¯å¤„ç†æ¡†æ¶
 *
 * ğŸ—ï¸ æ ¸å¿ƒåŠŸèƒ½ï¼š
 * - å®šä¹‰ç”¨æˆ·ã€åŠ©æ‰‹å’Œè¿›åº¦æ¶ˆæ¯çš„ç»Ÿä¸€æ¥å£
 * - æ”¯æŒå·¥å…·è°ƒç”¨ç»“æœçš„é›†æˆå’Œä¼ é€’
 * - æä¾›å®Œæ•´çš„å¯¹è¯ä¼šè¯ç±»å‹å®‰å…¨
 * - é›†æˆæˆæœ¬è¿½è¸ªå’Œæ€§èƒ½ç›‘æ§æ•°æ®
 *
 * ğŸ”„ ä¾èµ–å…³ç³»ï¼š
 * - ä¸Šæ¸¸ï¼šè¢«è°ƒè¯•æ—¥å¿—å™¨å’Œå¯¹è¯ç›¸å…³å·¥å…·ä½¿ç”¨
 * - ä¸‹æ¸¸ï¼šä¾èµ– Anthropic AI SDK å’Œ crypto UUID
 *
 * ğŸ“Š ä½¿ç”¨åœºæ™¯ï¼š
 * - å¯¹è¯å†å²çš„åºåˆ—åŒ–å’Œååºåˆ—åŒ–
 * - æ¶ˆæ¯æµçš„ç±»å‹å®‰å…¨å¤„ç†
 * - å·¥å…·æ‰§è¡Œç»“æœçš„æ¶ˆæ¯é›†æˆ
 * - è°ƒè¯•å’Œæ—¥å¿—è®°å½•çš„ç»Ÿä¸€æ¥å£
 *
 * ğŸ”§ æŠ€æœ¯å®ç°ï¼š
 * - ä¸ query.ts ä¸­çš„ Message ç±»å‹ä¿æŒä¸€è‡´
 * - æ”¯æŒ Anthropic AI SDK çš„åŸç”Ÿæ¶ˆæ¯æ ¼å¼
 * - åŒ…å«å®Œæ•´çš„å…ƒæ•°æ®å’Œé€‰é¡¹é…ç½®
 * - ç±»å‹å®‰å…¨çš„è”åˆç±»å‹å®šä¹‰
 */

import { UUID } from 'crypto'
import type { MessageParam } from '@anthropic-ai/sdk/resources/index.mjs'
import type { Message as APIAssistantMessage } from '@anthropic-ai/sdk/resources/index.mjs'

/**
 * åŸºç¡€æ¶ˆæ¯æ¥å£ - å¯¹è¯ç³»ç»Ÿä¸­ä½¿ç”¨çš„ç»Ÿä¸€æ¶ˆæ¯ç±»å‹
 *
 * è¿™æ˜¯ä¸€ä¸ªè”åˆç±»å‹ï¼Œä¸ query.ts ä¸­çš„ Message ç±»å‹ä¿æŒå®Œå…¨ä¸€è‡´ï¼Œ
 * ç¡®ä¿æ•´ä¸ªç³»ç»Ÿä¸­æ¶ˆæ¯ç±»å‹çš„ç»Ÿä¸€æ€§å’Œç±»å‹å®‰å…¨ã€‚
 */
export type Message = UserMessage | AssistantMessage | ProgressMessage

/**
 * ç”¨æˆ·æ¶ˆæ¯ç»“æ„ - æ¥è‡ªç”¨æˆ·çš„è¾“å…¥æ¶ˆæ¯å’Œå·¥å…·æ‰§è¡Œç»“æœ
 */
export interface UserMessage {
  /** ç¬¦åˆ Anthropic API æ ¼å¼çš„æ¶ˆæ¯å‚æ•° */
  message: MessageParam
  /** æ¶ˆæ¯ç±»å‹æ ‡è¯† */
  type: 'user'
  /** æ¶ˆæ¯çš„å”¯ä¸€æ ‡è¯†ç¬¦ */
  uuid: UUID
  /** å·¥å…·ä½¿ç”¨çš„å®Œæ•´ç»“æœ (FullToolUseResult ç±»å‹) */
  toolUseResult?: any
  /** ç”¨æˆ·æ¶ˆæ¯çš„å¯é€‰é…ç½® */
  options?: {
    /** æ˜¯å¦ä¸ºç¼–ç¨‹è¯·æ±‚ */
    isKodingRequest?: boolean
    /** ç¼–ç¨‹ä¸Šä¸‹æ–‡ä¿¡æ¯ */
    kodingContext?: string
  }
}

/**
 * åŠ©æ‰‹æ¶ˆæ¯ç»“æ„ - AI åŠ©æ‰‹çš„å“åº”æ¶ˆæ¯å’Œå…ƒæ•°æ®
 */
export interface AssistantMessage {
  /** æœ¬æ¬¡å“åº”çš„ç¾å…ƒæˆæœ¬ */
  costUSD: number
  /** å“åº”ç”Ÿæˆè€—æ—¶ï¼ˆæ¯«ç§’ï¼‰ */
  durationMs: number
  /** ç¬¦åˆ Anthropic API æ ¼å¼çš„åŠ©æ‰‹æ¶ˆæ¯ */
  message: APIAssistantMessage
  /** æ¶ˆæ¯ç±»å‹æ ‡è¯† */
  type: 'assistant'
  /** æ¶ˆæ¯çš„å”¯ä¸€æ ‡è¯†ç¬¦ */
  uuid: UUID
  /** æ˜¯å¦ä¸º API é”™è¯¯æ¶ˆæ¯ */
  isApiErrorMessage?: boolean
}

/**
 * è¿›åº¦æ¶ˆæ¯ç»“æ„ - å·¥å…·æ‰§è¡Œè¿‡ç¨‹ä¸­çš„è¿›åº¦æ›´æ–°æ¶ˆæ¯
 *
 * ç”¨äºåœ¨å·¥å…·æ‰§è¡ŒæœŸé—´å‘ç”¨æˆ·æ˜¾ç¤ºå®æ—¶è¿›åº¦å’ŒçŠ¶æ€æ›´æ–°ã€‚
 */
export interface ProgressMessage {
  /** åŒ…å«çš„åŠ©æ‰‹æ¶ˆæ¯å†…å®¹ */
  content: AssistantMessage
  /** æ ‡å‡†åŒ–çš„æ¶ˆæ¯åˆ—è¡¨ (NormalizedMessage ç±»å‹) */
  normalizedMessages: any[]
  /** å¹¶è¡Œæ‰§è¡Œçš„å·¥å…·ä½¿ç”¨ ID é›†åˆ */
  siblingToolUseIDs: Set<string>
  /** ç›¸å…³çš„å·¥å…·åˆ—è¡¨ (Tool ç±»å‹) */
  tools: any[]
  /** å½“å‰å·¥å…·ä½¿ç”¨çš„ ID */
  toolUseID: string
  /** æ¶ˆæ¯ç±»å‹æ ‡è¯† */
  type: 'progress'
  /** æ¶ˆæ¯çš„å”¯ä¸€æ ‡è¯†ç¬¦ */
  uuid: UUID
}