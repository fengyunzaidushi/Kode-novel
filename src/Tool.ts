/**
 * ğŸ¯ å·¥å…·ç³»ç»Ÿæ ¸å¿ƒæ¥å£ - Kode å¯æ‰©å±•æ¶æ„çš„åŸºç¡€å±‚
 *
 * ğŸ—ï¸ æ ¸å¿ƒåŠŸèƒ½ï¼š
 * - å®šä¹‰æ‰€æœ‰å·¥å…·å¿…é¡»å®ç°çš„æ ‡å‡†åŒ–å¥‘çº¦
 * - æä¾›ç±»å‹å®‰å…¨çš„å·¥å…·è¾“å…¥è¾“å‡ºæ¥å£
 * - é›†æˆæƒé™ç³»ç»Ÿå’Œå®‰å…¨éªŒè¯æœºåˆ¶
 * - æ”¯æŒå¼‚æ­¥æ“ä½œå’Œæµå¼è¾“å‡ºå¤„ç†
 *
 * ğŸ”„ ä¾èµ–å…³ç³»ï¼š
 * - ä¸Šæ¸¸ï¼šè¢«æ‰€æœ‰å…·ä½“å·¥å…·å®ç°å’Œå·¥å…·ç®¡ç†å™¨ä½¿ç”¨
 * - ä¸‹æ¸¸ï¼šä¾èµ– Zod éªŒè¯åº“å’Œ React ç»„ä»¶ç³»ç»Ÿ
 *
 * ğŸ“Š ä½¿ç”¨åœºæ™¯ï¼š
 * - å·¥å…·ç³»ç»Ÿçš„æ¶æ„åŸºç¡€å®šä¹‰
 * - æ–°å·¥å…·å¼€å‘çš„æ¥å£è§„èŒƒ
 * - å·¥å…·æƒé™ç®¡ç†å’Œå®‰å…¨éªŒè¯
 * - AI ä»£ç†çš„å·¥å…·è°ƒç”¨å’Œç»“æœå¤„ç†
 *
 * ğŸ”§ æŠ€æœ¯å®ç°ï¼š
 * - åŸºäº TypeScript æ³›å‹çš„ç±»å‹å®‰å…¨è®¾è®¡
 * - Zod è¿è¡Œæ—¶ç±»å‹éªŒè¯å’Œ JSON Schema æ”¯æŒ
 * - React ç»„ä»¶é›†æˆç”¨äº UI æ¸²æŸ“
 * - å¼‚æ­¥ç”Ÿæˆå™¨æ¨¡å¼æ”¯æŒæµå¼å¤„ç†
 */

// å¯¼å…¥Zodåº“ï¼Œç”¨äºè¿è¡Œæ—¶ç±»å‹éªŒè¯å’Œæ¨¡å¼å®šä¹‰
import { z } from 'zod'
// å¯¼å…¥Reactåº“ï¼Œç”¨äºJSXç»„ä»¶ç±»å‹å®šä¹‰
import * as React from 'react'

/**
 * å·¥å…· JSX è®¾ç½®å‡½æ•°ç±»å‹ - å·¥å…· UI ç»„ä»¶æ¸²æŸ“æ§åˆ¶å™¨
 *
 * ç”¨äºåœ¨å·¥å…·æ‰§è¡ŒæœŸé—´åŠ¨æ€è®¾ç½®å’Œæ›´æ–°ç”¨æˆ·ç•Œé¢ç»„ä»¶ï¼Œ
 * æ”¯æŒå·¥å…·çš„å®æ—¶äº¤äº’å’ŒçŠ¶æ€æ˜¾ç¤ºã€‚
 *
 * @param jsx - JSX é…ç½®å¯¹è±¡æˆ– nullï¼ˆæ¸…é™¤æ˜¾ç¤ºï¼‰
 * @param jsx.jsx - è¦æ˜¾ç¤ºçš„ React ç»„ä»¶èŠ‚ç‚¹
 * @param jsx.shouldHidePromptInput - æ˜¯å¦éšè—ç”¨æˆ·è¾“å…¥æ¡†
 */
export type SetToolJSXFn = (jsx: {
  jsx: React.ReactNode | null        // è¦æ˜¾ç¤ºçš„Reactç»„ä»¶èŠ‚ç‚¹ï¼Œå¯ä»¥ä¸ºnull
  shouldHidePromptInput: boolean     // æ˜¯å¦åº”è¯¥éšè—æç¤ºè¾“å…¥æ¡†
} | null) => void                    // æ•´ä¸ªå‚æ•°å¯ä»¥ä¸ºnullè¡¨ç¤ºæ¸…é™¤JSX

/**
 * å·¥å…·ä½¿ç”¨ä¸Šä¸‹æ–‡æ¥å£ - å·¥å…·æ‰§è¡Œæ—¶çš„å®Œæ•´ç¯å¢ƒä¿¡æ¯
 *
 * åŒ…å«å·¥å…·æ‰§è¡Œæ‰€éœ€çš„æ‰€æœ‰ä¸Šä¸‹æ–‡æ•°æ®ï¼ŒåŒ…æ‹¬æ¶ˆæ¯çŠ¶æ€ã€
 * é…ç½®é€‰é¡¹ã€æ–‡ä»¶ç¼“å­˜ä¿¡æ¯å’Œæ¨¡å‹å“åº”çŠ¶æ€ã€‚
 */
export interface ToolUseContext {
  messageId: string | undefined      // å½“å‰æ¶ˆæ¯çš„å”¯ä¸€æ ‡è¯†ç¬¦
  agentId?: string                   // å¯é€‰çš„ä»£ç†æ ‡è¯†ç¬¦
  safeMode?: boolean                 // å¯é€‰çš„å®‰å…¨æ¨¡å¼æ ‡å¿—
  abortController: AbortController   // ç”¨äºå–æ¶ˆå·¥å…·æ“ä½œçš„æ§åˆ¶å™¨
  readFileTimestamps: { [filePath: string]: number }  // æ–‡ä»¶è¯»å–æ—¶é—´æˆ³æ˜ å°„ï¼Œç”¨äºç¼“å­˜æ§åˆ¶
  options?: {                        // å¯é€‰çš„é…ç½®é€‰é¡¹
    commands?: any[]                 // å¯ç”¨å‘½ä»¤åˆ—è¡¨
    tools?: any[]                    // å¯ç”¨å·¥å…·åˆ—è¡¨
    verbose?: boolean                // è¯¦ç»†è¾“å‡ºæ¨¡å¼æ ‡å¿—
    slowAndCapableModel?: string     // æ…¢é€Ÿä½†åŠŸèƒ½å¼ºå¤§çš„æ¨¡å‹åç§°
    safeMode?: boolean               // å®‰å…¨æ¨¡å¼æ ‡å¿—
    forkNumber?: number              // åˆ†å‰ç¼–å·
    messageLogName?: string          // æ¶ˆæ¯æ—¥å¿—åç§°
    maxThinkingTokens?: any          // æœ€å¤§æ€è€ƒtokenæ•°
    isKodingRequest?: boolean        // æ˜¯å¦ä¸ºKodingè¯·æ±‚
    kodingContext?: string           // Kodingä¸Šä¸‹æ–‡
    isCustomCommand?: boolean        // æ˜¯å¦ä¸ºè‡ªå®šä¹‰å‘½ä»¤
  }
  // GPT-5 å“åº”APIçŠ¶æ€ç®¡ç†
  responseState?: {
    previousResponseId?: string      // å‰ä¸€ä¸ªå“åº”çš„ID
    conversationId?: string          // å¯¹è¯ID
  }
}

/**
 * æ‰©å±•å·¥å…·ä½¿ç”¨ä¸Šä¸‹æ–‡æ¥å£ - åŒ…å« UI äº¤äº’èƒ½åŠ›çš„å·¥å…·ä¸Šä¸‹æ–‡
 *
 * ç»§æ‰¿åŸºç¡€å·¥å…·ä¸Šä¸‹æ–‡ï¼Œå¢åŠ äº† JSX ç»„ä»¶æ¸²æŸ“æ§åˆ¶åŠŸèƒ½ï¼Œ
 * æ”¯æŒå·¥å…·çš„åŠ¨æ€ UI æ›´æ–°å’Œç”¨æˆ·äº¤äº’ã€‚
 */
export interface ExtendedToolUseContext extends ToolUseContext {
  /** è®¾ç½®å·¥å…· JSX æ˜¾ç¤ºçš„å‡½æ•° - ç”¨äºåŠ¨æ€æ›´æ–°å·¥å…· UI */
  setToolJSX: SetToolJSXFn
}

/**
 * éªŒè¯ç»“æœæ¥å£ - å·¥å…·è¾“å…¥éªŒè¯çš„æ ‡å‡†åŒ–è¿”å›å€¼
 *
 * æä¾›ç»Ÿä¸€çš„éªŒè¯ç»“æœæ ¼å¼ï¼Œæ”¯æŒè¯¦ç»†çš„é”™è¯¯ä¿¡æ¯
 * å’Œå…ƒæ•°æ®ä¼ é€’ï¼Œç¡®ä¿éªŒè¯è¿‡ç¨‹çš„å¯è¿½æº¯æ€§ã€‚
 */
export interface ValidationResult {
  /** éªŒè¯æ˜¯å¦é€šè¿‡ */
  result: boolean
  /** å¯é€‰çš„éªŒè¯æ¶ˆæ¯ - ç”¨äºè¯¦ç»†è¯´æ˜éªŒè¯ç»“æœ */
  message?: string
  /** å¯é€‰çš„é”™è¯¯ä»£ç  - ç”¨äºç¨‹åºåŒ–å¤„ç†éªŒè¯é”™è¯¯ */
  errorCode?: number
  /** å¯é€‰çš„å…ƒæ•°æ® - ç”¨äºä¼ é€’é¢å¤–çš„éªŒè¯ä¿¡æ¯ */
  meta?: any
}

/**
 * æ ¸å¿ƒå·¥å…·æ¥å£ - Kode å·¥å…·ç³»ç»Ÿçš„æ ‡å‡†åŒ–å¥‘çº¦
 *
 * å®šä¹‰æ‰€æœ‰å·¥å…·å¿…é¡»å®ç°çš„å®Œæ•´æ¥å£è§„èŒƒï¼ŒåŒ…æ‹¬ç±»å‹å®‰å…¨ã€
 * æƒé™æ§åˆ¶ã€éªŒè¯æœºåˆ¶å’Œå¼‚æ­¥æ‰§è¡Œæ”¯æŒã€‚
 *
 * @template TInput - å·¥å…·è¾“å…¥ç±»å‹ï¼Œå¿…é¡»æ˜¯ Zod å¯¹è±¡æ¨¡å¼
 * @template TOutput - å·¥å…·è¾“å‡ºç±»å‹ï¼Œå¯ä»¥æ˜¯ä»»æ„ç±»å‹
 */
export interface Tool<
  TInput extends z.ZodObject<any> = z.ZodObject<any>,  // è¾“å…¥ç±»å‹ï¼Œå¿…é¡»æ˜¯Zodå¯¹è±¡æ¨¡å¼
  TOutput = any,                                       // è¾“å‡ºç±»å‹ï¼Œå¯ä»¥æ˜¯ä»»æ„ç±»å‹
> {
  /** å·¥å…·åç§° - å”¯ä¸€æ ‡è¯†ç¬¦ */
  name: string

  /** å·¥å…·æè¿°ç”Ÿæˆå‡½æ•° - å¼‚æ­¥è·å–å·¥å…·åŠŸèƒ½è¯´æ˜ */
  description?: () => Promise<string>

  /** è¾“å…¥æ•°æ®éªŒè¯æ¨¡å¼ - åŸºäº Zod çš„ç±»å‹å®‰å…¨éªŒè¯ */
  inputSchema: TInput

  /** JSON Schema è¡¨ç¤º - å¯é€‰çš„æ ‡å‡†åŒ–æ¨¡å¼æè¿° */
  inputJSONSchema?: Record<string, unknown>

  /**
   * å·¥å…·æç¤ºè¯ç”Ÿæˆå‡½æ•° - ä¸º AI æ¨¡å‹ç”Ÿæˆä½¿ç”¨æŒ‡å¯¼
   *
   * @param options - å¯é€‰é…ç½®ï¼ŒåŒ…æ‹¬å®‰å…¨æ¨¡å¼ç­‰
   * @returns ç”Ÿæˆçš„æç¤ºè¯å­—ç¬¦ä¸²
   */
  prompt: (options?: { safeMode?: boolean }) => Promise<string>

  /** ç”¨æˆ·ç•Œé¢æ˜¾ç¤ºåç§°ç”Ÿæˆå‡½æ•° - å¯é€‰çš„å‹å¥½åç§° */
  userFacingName?: () => string

  /**
   * å·¥å…·å¯ç”¨çŠ¶æ€æ£€æŸ¥ - å¼‚æ­¥æ£€æŸ¥å·¥å…·æ˜¯å¦å¯ç”¨
   *
   * @returns å·¥å…·æ˜¯å¦å¯ç”¨çš„å¸ƒå°”å€¼
   */
  isEnabled: () => Promise<boolean>

  /**
   * åªè¯»æ¨¡å¼æ£€æŸ¥ - ç¡®å®šå·¥å…·æ˜¯å¦ä¿®æ”¹ç³»ç»ŸçŠ¶æ€
   *
   * @returns æ˜¯å¦ä¸ºåªè¯»å·¥å…·
   */
  isReadOnly: () => boolean

  /**
   * å¹¶å‘å®‰å…¨æ£€æŸ¥ - ç¡®å®šå·¥å…·æ˜¯å¦æ”¯æŒå¹¶å‘æ‰§è¡Œ
   *
   * @returns æ˜¯å¦æ”¯æŒå¹¶å‘æ‰§è¡Œ
   */
  isConcurrencySafe: () => boolean

  /**
   * æƒé™éœ€æ±‚æ£€æŸ¥ - ç¡®å®šæ˜¯å¦éœ€è¦ç”¨æˆ·æˆæƒ
   *
   * @param input - å¯é€‰çš„è¾“å…¥æ•°æ®ï¼Œç”¨äºæ¡ä»¶æ€§æƒé™æ£€æŸ¥
   * @returns æ˜¯å¦éœ€è¦ç”¨æˆ·æƒé™
   */
  needsPermissions: (input?: z.infer<TInput>) => boolean

  /**
   * è¾“å…¥éªŒè¯å‡½æ•° - å¯é€‰çš„è‡ªå®šä¹‰éªŒè¯é€»è¾‘
   *
   * @param input - å¾…éªŒè¯çš„è¾“å…¥æ•°æ®
   * @param context - å¯é€‰çš„å·¥å…·ä½¿ç”¨ä¸Šä¸‹æ–‡
   * @returns éªŒè¯ç»“æœå¯¹è±¡
   */
  validateInput?: (
    input: z.infer<TInput>,
    context?: ToolUseContext,
  ) => Promise<ValidationResult>

  /**
   * AI åŠ©æ‰‹ç»“æœæ¸²æŸ“å™¨ - å°†å·¥å…·è¾“å‡ºæ ¼å¼åŒ–ä¸º AI å¯ç†è§£çš„å½¢å¼
   *
   * @param output - å·¥å…·æ‰§è¡Œè¾“å‡º
   * @returns æ ¼å¼åŒ–çš„å­—ç¬¦ä¸²æˆ–å¯¹è±¡æ•°ç»„
   */
  renderResultForAssistant: (output: TOutput) => string | any[]

  /**
   * å·¥å…·ä½¿ç”¨æ¶ˆæ¯æ¸²æŸ“å™¨ - ç”Ÿæˆå·¥å…·è°ƒç”¨çš„æ˜¾ç¤ºæ¶ˆæ¯
   *
   * @param input - å·¥å…·è¾“å…¥æ•°æ®
   * @param options - æ¸²æŸ“é€‰é¡¹ï¼ŒåŒ…æ‹¬è¯¦ç»†æ¨¡å¼æ ‡å¿—
   * @returns æ ¼å¼åŒ–çš„æ¶ˆæ¯å­—ç¬¦ä¸²
   */
  renderToolUseMessage: (
    input: z.infer<TInput>,
    options: { verbose: boolean },
  ) => string

  /** å·¥å…·ä½¿ç”¨è¢«æ‹’ç»æ¶ˆæ¯æ¸²æŸ“å™¨ - å¯é€‰çš„æƒé™æ‹’ç» UI ç»„ä»¶ */
  renderToolUseRejectedMessage?: (...args: any[]) => React.ReactElement

  /** å·¥å…·ç»“æœæ¶ˆæ¯æ¸²æŸ“å™¨ - å¯é€‰çš„ç»“æœæ˜¾ç¤º UI ç»„ä»¶ */
  renderToolResultMessage?: (output: TOutput) => React.ReactElement

  /**
   * å·¥å…·æ ¸å¿ƒæ‰§è¡Œå‡½æ•° - å¼‚æ­¥ç”Ÿæˆå™¨æ¨¡å¼æ”¯æŒæµå¼å¤„ç†
   *
   * @param input - éªŒè¯åçš„è¾“å…¥æ•°æ®
   * @param context - å·¥å…·æ‰§è¡Œä¸Šä¸‹æ–‡
   * @returns å¼‚æ­¥ç”Ÿæˆå™¨ï¼Œäº§ç”Ÿç»“æœæˆ–è¿›åº¦ä¿¡æ¯
   */
  call: (
    input: z.infer<TInput>,
    context: ToolUseContext,
  ) => AsyncGenerator<
    | { type: 'result'; data: TOutput; resultForAssistant?: string }      // æœ€ç»ˆç»“æœè¾“å‡º
    | { type: 'progress'; content: any; normalizedMessages?: any[]; tools?: any[] },  // è¿›åº¦çŠ¶æ€è¾“å‡º
    void,                                             // ç”Ÿæˆå™¨ä¸è¿”å›å€¼
    unknown                                           // ç”Ÿæˆå™¨ä¸æ¥å—è¾“å…¥
  >
}
